\newkeycommand{\bnet}[x = 0cm, y = 0cm, width = 3.4cm, height = 1.8cm, name = bnet][1]{
\node[fill = white, cylinder, shape border rotate = 90, draw, minimum height = \commandkey{height}, minimum width = \commandkey{width}, align = center, shape aspect=2] (\commandkey{name}) at (\commandkey{x}, \commandkey{y}) {};

\draw[dashed, line width = 0.5pt]
let \p1 = ($ (\commandkey{name}.after bottom) - (\commandkey{name}.before bottom) $),
    \n1 = {0.5*veclen(\x1,\y1)-\pgflinewidth},
    \p2 = ($ (\commandkey{name}.bottom) - (\commandkey{name}.after bottom)!.5!(\commandkey{name}.before bottom) $),
    \n2 = {veclen(\x2,\y2)-\pgflinewidth}
in
    ([xshift=-\pgflinewidth] \commandkey{name}.before bottom) arc [start angle=0, end angle=180,
    x radius=\n1, y radius=\n2];

\begin{scope}
\clip
let \p1 = ($ (\commandkey{name}.after bottom) - (\commandkey{name}.before bottom) $),
    \n1 = {0.5*veclen(\x1,\y1)-\pgflinewidth},
    \p2 = ($ (\commandkey{name}.bottom) - (\commandkey{name}.after bottom)!.5!(\commandkey{name}.before bottom) $),
    \n2 = {veclen(\x2,\y2)-\pgflinewidth}
in
    (\commandkey{name}.after bottom) arc [start angle=180, end angle=360,
    x radius=\n1 + \pgflinewidth, y radius=\n2 + \pgflinewidth];

\foreach \i in {1,2,3,4}{
\draw[white, line width = 3pt] ($(\commandkey{name}.after bottom)!0.2*\i!(\commandkey{name}.before bottom)$) -- ++ (-90:2cm);

\draw[blue, densely dotted, blue, <-] ($(\commandkey{name}.after bottom)!0.2*\i!(\commandkey{name}.before bottom)$) -- ++ (-90:2cm);
}
\end{scope}

\draw[white, line width = 3pt] ($(\commandkey{name}.after top)!0.5!(\commandkey{name}.before top)$) -- ++ (90:0.25cm);

\coordinate (\commandkey{name}BottomCenter) at ($(\commandkey{name}.after bottom)!0.5!(\commandkey{name}.before bottom)$);
\coordinate (\commandkey{name}TopCenter) at ($(\commandkey{name}.after top)!0.5!(\commandkey{name}.before top)$);

\coordinate (\commandkey{name}Bottom1) at ($(\commandkey{name}.after bottom)!0.2!(\commandkey{name}.before bottom) + (0, -0.24cm)$);
\coordinate (\commandkey{name}Bottom2) at ($(\commandkey{name}.after bottom)!0.4!(\commandkey{name}.before bottom) + (0, -0.3cm)$);
\coordinate (\commandkey{name}Bottom3) at ($(\commandkey{name}.after bottom)!0.6!(\commandkey{name}.before bottom) + (0, -0.3cm)$);
\coordinate (\commandkey{name}Bottom4) at ($(\commandkey{name}.after bottom)!0.8!(\commandkey{name}.before bottom) + (0, -0.24cm)$);

\node at (\commandkey{x}, \commandkey{y}) [fill = white, align = center, inner sep = 1pt] {#1};
}

\newkeycommand{\amodel}[x = 0cm, y = 0cm, width = 3.4cm, height = 1.8cm, name = amodel][1]{
\node[fill = white, cylinder, shape border rotate = 90, draw, minimum height = \commandkey{height}, minimum width = \commandkey{width}, align = center, shape aspect=2] (\commandkey{name}) at (\commandkey{x}, \commandkey{y}) {};

\draw[dashed, line width = 0.5pt]
let \p1 = ($ (\commandkey{name}.after bottom) - (\commandkey{name}.before bottom) $),
    \n1 = {0.5*veclen(\x1,\y1)-\pgflinewidth},
    \p2 = ($ (\commandkey{name}.bottom) - (\commandkey{name}.after bottom)!.5!(\commandkey{name}.before bottom) $),
    \n2 = {veclen(\x2,\y2)-\pgflinewidth}
in
    ([xshift=-\pgflinewidth] \commandkey{name}.before bottom) arc [start angle=0, end angle=180,
    x radius=\n1, y radius=\n2];

\begin{scope}
\clip
let \p1 = ($ (\commandkey{name}.after bottom) - (\commandkey{name}.before bottom) $),
    \n1 = {0.5*veclen(\x1,\y1)-\pgflinewidth},
    \p2 = ($ (\commandkey{name}.bottom) - (\commandkey{name}.after bottom)!.5!(\commandkey{name}.before bottom) $),
    \n2 = {veclen(\x2,\y2)-\pgflinewidth}
in
    (\commandkey{name}.after bottom) arc [start angle=180, end angle=360,
    x radius=\n1 + \pgflinewidth, y radius=\n2 + \pgflinewidth];

\draw[white, line width = 3pt] ($(\commandkey{name}.after bottom)!0.5!(\commandkey{name}.before bottom)$) -- ++ (-90:2cm);

\draw[blue, densely dotted, blue, <-] ($(\commandkey{name}.after bottom)!0.5!(\commandkey{name}.before bottom)$) -- ++ (-90:2cm);
\end{scope}

\draw[white, line width = 3pt] ($(\commandkey{name}.after top)!0.5!(\commandkey{name}.before top)$) -- ++ (90:0.25cm);

\coordinate (\commandkey{name}BottomCenter) at ($(\commandkey{name}.after bottom)!0.5!(\commandkey{name}.before bottom)$);
\coordinate (\commandkey{name}TopCenter) at ($(\commandkey{name}.after top)!0.5!(\commandkey{name}.before top)$);

\node at (\commandkey{x}, \commandkey{y}) [fill = white, align = center, inner sep = 1pt] {#1};
}

\newkeycommand{\camodel}[x = 0cm, y = 0cm, width = 3.4cm, height = 1.8cm, name = camodel][1]{
\node[fill = white, cylinder, shape border rotate = 90, draw, minimum height = \commandkey{height}, minimum width = \commandkey{width}, align = center, shape aspect=2] (\commandkey{name}) at (\commandkey{x}, \commandkey{y}) {};

\draw[dashed, line width = 0.5pt]
let \p1 = ($ (\commandkey{name}.after bottom) - (\commandkey{name}.before bottom) $),
    \n1 = {0.5*veclen(\x1,\y1)-\pgflinewidth},
    \p2 = ($ (\commandkey{name}.bottom) - (\commandkey{name}.after bottom)!.5!(\commandkey{name}.before bottom) $),
    \n2 = {veclen(\x2,\y2)-\pgflinewidth}
in
    ([xshift=-\pgflinewidth] \commandkey{name}.before bottom) arc [start angle=0, end angle=180,
    x radius=\n1, y radius=\n2];

\draw[white, line width = 3pt] ($(\commandkey{name}.after top)!0.5!(\commandkey{name}.before top)$) -- ++ (90:0.25cm);

\coordinate (\commandkey{name}BottomCenter) at ($(\commandkey{name}.after bottom)!0.5!(\commandkey{name}.before bottom)$);
\coordinate (\commandkey{name}TopCenter) at ($(\commandkey{name}.after top)!0.5!(\commandkey{name}.before top)$);

\node at (\commandkey{x}, \commandkey{y}) [fill = white, align = center, inner sep = 1pt] {#1};
}

\newkeycommand{\database}[x = 0cm, y = 0cm, width = 3.4cm, height = 1.8cm, name = database][1]{
\node[fill = white, cylinder, shape border rotate = 90, draw, minimum height = \commandkey{height}, minimum width = \commandkey{width}, align = center, shape aspect=2] (\commandkey{name}) at (\commandkey{x}, \commandkey{y}) {};

\draw[dashed, line width = 0.5pt]
let \p1 = ($ (\commandkey{name}.after bottom) - (\commandkey{name}.before bottom) $),
    \n1 = {0.5*veclen(\x1,\y1)-\pgflinewidth},
    \p2 = ($ (\commandkey{name}.bottom) - (\commandkey{name}.after bottom)!.5!(\commandkey{name}.before bottom) $),
    \n2 = {veclen(\x2,\y2)-\pgflinewidth}
in
    ([xshift=-\pgflinewidth] \commandkey{name}.before bottom) arc [start angle=0, end angle=180,
    x radius=\n1, y radius=\n2];

\begin{scope}
\clip
let \p1 = ($ (\commandkey{name}.after bottom) - (\commandkey{name}.before bottom) $),
    \n1 = {0.5*veclen(\x1,\y1)-\pgflinewidth},
    \p2 = ($ (\commandkey{name}.bottom) - (\commandkey{name}.after bottom)!.5!(\commandkey{name}.before bottom) $),
    \n2 = {veclen(\x2,\y2)-\pgflinewidth}
in
    (\commandkey{name}.after bottom) arc [start angle=180, end angle=360,
    x radius=\n1 + \pgflinewidth, y radius=\n2 + \pgflinewidth];


\draw[white, line width = 3pt] ($(\commandkey{name}.after bottom)!0.5!(\commandkey{name}.before bottom)$) -- ++ (-90:2cm);

\draw[densely dotted, black, <-] ($(\commandkey{name}.after bottom)!0.5!(\commandkey{name}.before bottom)$) -- ++ (-90:2cm);
\end{scope}

\coordinate (\commandkey{name}BottomCenter) at ($(\commandkey{name}.after bottom)!0.5!(\commandkey{name}.before bottom)$);
\coordinate (\commandkey{name}TopCenter) at ($(\commandkey{name}.after top)!0.5!(\commandkey{name}.before top)$);

\node at (\commandkey{x}, \commandkey{y}) [fill = white, align = center, inner sep = 1pt] {#1};
}

\begin{tikzpicture}[line width = 1pt,
                    font = \small,
                    block/.style = {draw, fill = white, rectangle, inner sep = 0pt, align = center, minimum height = 1.5cm, minimum width = 3.4cm},
                    knowledge/.style = {block, minimum width = 2.5cm, minimum height = 1.8cm},
                    subblock/.style = {draw = white, rectangle, inner sep = 0pt, align = center, fill = black!80, minimum width = 1.6cm, minimum height = 1cm, line width = 0.5pt, font = \footnotesize, text = white}]
\linespread{1}

% Draw help lines.
% \draw (-5, -4) to[grid with coordinates]  (18, 9);

% Industrial Control System
\node[rectangle, draw, rounded corners, minimum width = 6.8cm, minimum height = 2.6cm] (ICS) at (7, -1.5) {};
\node[rectangle, draw, minimum width = 2.8cm, minimum height = 1.4cm, inner sep = 0pt, align = center] at (5.2, -1.9) {Control System};
\node[rectangle, draw, minimum width = 2.8cm, minimum height = 1.4cm, inner sep = 0pt, align = center] at (8.8, -1.9) {Physical System};
\node at (7, -0.7) {\large \bf Industrial Control System};
\begin{scope}
	\draw[name path=rectangle, draw = none] (6.65, -2.8) rectangle (7.35,1);
	\draw[name path=circle, draw = none] (7, -1.9) circle (0.6);
	\tkzDefPoint(7, -1.9){O}
	\draw [name intersections={of=rectangle and circle, by={a,b,c,d}}] (O) circle (0pt);
	
	\tikzset{compass style/.append style={<-, line width= 1pt}}
	\tkzDrawArc[color=black](O,b)(d)
	\tkzDrawArc[color=black](O,c)(a)
\end{scope}
\pause

% Intrusion Detection System
\node[fill = black!30, rectangle, rounded corners, minimum width = 3cm, minimum height = 1.7cm] (IDS) at (-3.5, 7.25) {};
\shadowtext[align = center] at (-3.5, 7.25) {\large \bf Intrusion\\[2pt]\large \bf Detection\\[2pt] \large \bf System};

% Dynamic Risk Assessment Module
\fill[black!30, rounded corners] (0.8, 3.8) rectangle (12.3, 9);
\shadowtext[] at (6.55, 8.5) {\large \bf Dynamic Risk Assessment Module};

% Risk Based Decision Making
\node[fill = black!30, rectangle, rounded corners, minimum width = 3cm, minimum height = 1.7cm] (RDM) at (14.6, 7.25) {};
\shadowtext[align = center] at (14.6, 7.25) {\large \bf Risk Based\\[2pt]\large\bf Decision\\[2pt]\large\bf Making};

% Security Strategy Enforcement
\node[fill = black!30, rectangle, rounded corners, minimum width = 3cm, minimum height = 1.7cm] (SSE) at (14.6, 2.05) {};
\shadowtext[align = center] at (14.6, 2.05) {\large \bf Security\\[2pt]\large \bf Strategy\\[2pt]\large \bf Enforcement};

\draw[->] (ICS) -| (IDS);
\uncover<2-2>{\draw[->] (IDS) -- ++ (0:4.3cm);}
\draw[<-] (RDM) -- ++ (180:2.3cm);
\draw[->] (RDM) -- (SSE);
\draw[->] (SSE) |- (ICS);

\shadowtext[align = center] at (-1.1, 7.68) {Intrusion\\Alerts};
\shadowtext[align = center] at (1.8, -1.25) {Real-time Data};
\shadowtext[align = center] at (12.5, -1.25) {Task Scheduling Table};
\shadowtext[align = center] at (14.6, 4.75) {Security\\Strategies};
\shadowtext[] at (12.35, 7.5) {Risk};

\pause
\database[x = -1.75cm, y = 2cm, name = DB, width = 2cm] {Historical\\Database};
\node[text = white, circle, inner sep = 0pt, minimum size = 0.5cm, fill = black] (CUP3) at (0, 5) {$\bm{+}$};
\node[text = white, circle, inner sep = 0pt, minimum size = 0.5cm, fill = black] (CUP4) at (0, 7.25) {$\bm{+}$};
\uncover<3-3>{\draw[->] (CUP4) -- ++ (0:0.8cm);}

\draw[->] (ICS) -| (IDS);
\draw (DB) -- ++(270:3.5cm);
\draw[->] (IDS) -- (CUP4);
\draw[<-] (CUP3) -- ++(-90:6.5cm);
\draw[->] (CUP3) -| (CUP4);
\draw[white, line width = 3pt] (CUP3) -| (DBTopCenter);
\draw[<-] (CUP3) -| (DBTopCenter);

\pause
\node[block] (IE) at (7, 7.25) {\parbox{3.4cm}{\centering \Abfbai{} Engine}};
\bnet[x = 7cm, y = 4.69cm, name = BN]{Fuzzy Probability\\Bayesian Network};
\uncover<4-4>{\camodel[x = 7cm, y = 4.69cm, name = BN2]{Fuzzy Probability\\Bayesian Network};}
\node[block, minimum width = 2.4cm]  (DF) at (2.2, 7.25) {Data\\Filter};
\amodel[x = 11.2cm, y = 4.69, name = AV, width = 1.8cm] {Asset\\Values};
\uncover<4-4>{\camodel[x = 11.2cm, y = 4.69, name = AV2, width = 1.8cm] {Asset\\Values};}
\camodel[x = 2.2cm, y = 4.69, name = CM, width = 2.4cm] {Causal\\Model};

\node[text = white, circle, inner sep = 0pt, minimum size = 0.5cm, fill = black] (TIMES) at (11.2, 7.25) {$\bm{\times}$};

\draw[->] (CMTopCenter) -- (DF);
\draw[->] (DF) -- (IE);
\draw[->, blue] (BN.174) -- ++(180:1.9cm);


\draw[->] (BNTopCenter) -- (IE);
\draw[->] (IE) -- (TIMES);
\draw[->] (AVTopCenter) -- (TIMES);
\shadowtext[] at (4.35, 7.5) {Evidences};
\shadowtext[] at (9.85, 7.5) {Probabilities};

\draw[->] (CUP4) -- (DF);
\draw[->] (RDM) -- (SSE);
\draw[->] (SSE) |- (ICS);
\draw[->] (TIMES) -- (RDM);


\pause
\fill[black!30, rounded corners] (0.8, 0.5) rectangle (12.3, 3.6);
\shadowtext[] at (3, 3) {\large \bf System Knowledge};

\node[knowledge] (CAK) at (2.25, 1.6) {Cyber\\Attack\\Knowledge};
\node[knowledge] (SFK) at (4.75+1/3, 1.6) {System\\Function\\Knowledge};
\node[knowledge] (HIK) at (7.25+2/3, 1.6) {Hazardous\\Incident\\Knowledge};
\node[knowledge] (SAK) at (10.75, 1.6) {System\\Asset\\Knowledge};
\draw[blue] (SAK.north -| AV) -- (AV);
\draw[blue] (CAK.90) -- ++(90:0.9cm) -| (BNBottom1);
\draw[blue] (SFK.90) -- ++(90:0.6cm) -| (BNBottom2);
\draw[blue] (HIK.90) -- ++(90:0.6cm) -| (BNBottom3);
\draw[blue] (SAK.105) -- ++(90:0.9cm) -| (BNBottom4);
\shadowtext[] at (3, 3) {\large \bf System Knowledge};

\end{tikzpicture} 